<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Puissance 4</title>
    <link href="./style.css" rel="stylesheet" type="text/css">
    <script
			  src="./jquery-3.3.1.min.js"></script>
  </head>
  <body>
    <div id="menu-top">
      <ul>
        <li><a href="index.html">Liste des parties</a></li>
        <li><a onclick="newGame()">Nouvelle partie</a></li>
      </ul>
      <div class="menu-user">
        <div class="user"></div>
      </div>
    </div>

    <table class="plateau"></table>

    <div class="joueurs">
      <div class="content-home">
        <div class="listeJoueurs">
          <div class="displayInlineBlock">
            <div class="nameJoueur1 displayInlineBlock"></div>
            <div class="nameJoueur1image displayInlineBlock"></div>
          </div>

            <div>VS</div>
          <div class="displayInlineBlock">
            <div class="nameJoueur2 displayInlineBlock"></div>
            <div class="nameJoueur2image displayInlineBlock"></div>
          </div>
        </div>
      </div>
    </div>


    </div>

    <div class="infos"></div>
    <button class="boutonRetry" style="display:none" onclick="newGame()">Recommencer ?</button>

    <!-- The Modal -->
    <div id="myModal" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
        <!--<span class="close">&times;</span>-->
        <label for="pseudo">Entrez un pseudo : </label>
        <input type="text" id="pseudo" class="inputModal"></input>
        <br>
        <button id="buttonPseudo" class="buttonModal">Se connecter</button>
      </div>

    </div>

  </body>
</html>

<script src='./connexion.js'></script>
<script src="./functions.js"></script>

<script>
  const params = new URLSearchParams(location.search);

  let id = params.get('id');
  let idJoueur;

  let pseudo;

  if(localStorage.getItem('login') != null){
    pseudo = localStorage.getItem('login');
  }

  let plateauCourant = null;

  jQuery.get('http://localhost:8080/jeu/'+id).done(function(data){
    idJoueur = data.prochainJoueur;

    construirePlateau(data.plateau);

    let htmlJoueurs = "";

    for(let joueur of data.joueurs)
    {
      jQuery('.nameJoueur'+joueur.id).html(joueur['pseudo']);
    }



    if(data.joueurGagnant != null)
    {
      victoire(data.joueurGagnant)
    }
  });

  jQuery('.plateau').on("click", ".case", function(){
    jouer(idJoueur, jQuery(this).data('colonne'));
  });

  const construirePlateau = function(plateauJson)
  {
    let ligne, casePlateau, htmlLigne = "", htmlPlateau = "", pion;

    if(plateauCourant == null)
    {
      plateauCourant = plateauJson;

      for(ligne in plateauJson) {
        for(colonne in plateauJson[ligne])
        {
          pion = "";

          if(plateauJson[ligne][colonne] == "1")
            pion = "<div class='joueur1'></div>"
          else if(plateauJson[ligne][colonne] == "2")
            pion = "<div class='joueur2'></div>"

          htmlLigne += "<th class='case' data-colonne='"+colonne+"'>"+pion+"</th>";
        }
        htmlPlateau += "<tr class='ligne' data-ligne='"+ligne+"'>"+htmlLigne+"</tr>";
        htmlLigne = "";
      }
      jQuery('.plateau').html(htmlPlateau);
    }
    else {
      for(ligne in plateauJson) {
        for(colonne in plateauJson[ligne])
        {
          if(plateauJson[ligne][colonne] !== plateauCourant[ligne][colonne])
          {
            if(plateauJson[ligne][colonne] == "1")
              pion = "<div class='joueur1' style='top:-1000px'></div>"
            else if(plateauJson[ligne][colonne] == "2")
              pion = "<div class='joueur2' style='top:-1000px'></div>"

            faireAparaitrePion(ligne, colonne, pion);
          }
        }
      }

      plateauCourant = plateauJson;
    }
  }

  const faireAparaitrePion = function(ligne, colonne, pion){
    $('[data-ligne='+ligne+'] [data-colonne='+colonne+']').html(pion);
    $('[data-ligne='+ligne+'] [data-colonne='+colonne+'] div').animate({'top' : '1px'}, 300);
  }

  const jouer = function(idJoueur, colonne){
    jQuery.post('http://localhost:8080/jeu/'+id+'/jouer', {idJoueur, colonne}).done(function(data){
      if(data.statut == "victoire 1" || data.statut == "victoire 2")
      {
        construirePlateau(data.jeu.plateau);
        victoire(data.joueurGagnant);
      }
      else if(data.statut == "ok")
      {
        changeIdJoueur();
        construirePlateau(data.jeu.plateau);
      }
    });
  };

  const victoire = function(joueur){
    jQuery(".infos").html("Vicoire de "+joueur.pseudo);
    jQuery(".boutonRetry").show();
  }

  const changeIdJoueur = function()
  {
    if(idJoueur == "1")
      idJoueur = "2"
    else
      idJoueur = "1"
  }

</script>
